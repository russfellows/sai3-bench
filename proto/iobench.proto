syntax = "proto3";
package iobench;

message Empty {}

message PingReply {
  string version = 1;
}

message RunGetRequest {
  string uri  = 1;   // "s3://bucket/prefix/*" or "s3://bucket/prefix/"
  uint32 jobs = 2;   // concurrency per-agent
}

message RunPutRequest {
  string bucket      = 1;
  string prefix      = 2;  // "bench/"
  uint64 object_size = 3;  // bytes
  uint32 objects     = 4;  // number of objects
  uint32 concurrency = 5;  // per-agent parallel uploads
}

message OpSummary {
  uint64 total_bytes = 1;
  double seconds     = 2;
  string notes       = 3;
}

// v0.6.0: Distributed workload execution
message RunWorkloadRequest {
  string config_yaml = 1;          // Full YAML configuration as string
  string agent_id = 2;             // Unique agent identifier (e.g., "agent-1")
  string path_prefix = 3;          // Per-agent path isolation prefix (e.g., "agent-1/")
  int64 start_timestamp_ns = 4;    // Coordinated start time (nanoseconds since UNIX epoch)
  bool shared_storage = 5;         // True if storage is shared (S3/GCS/Azure), false if local per-agent
  
  // v0.8.7: For distributed prepare/cleanup with shared storage
  uint32 agent_index = 6;          // 0-based agent index (0, 1, 2, ...)
  uint32 num_agents = 7;           // Total number of agents in distributed execution
}

message OpAggregateMetrics {
  uint64 bytes = 1;
  uint64 ops = 2;
  uint64 mean_us = 3;
  uint64 p50_us = 4;
  uint64 p95_us = 5;
  uint64 p99_us = 6;
}

message WorkloadSummary {
  string agent_id = 1;
  double wall_seconds = 2;
  uint64 total_ops = 3;
  uint64 total_bytes = 4;
  
  // Per-operation aggregates
  OpAggregateMetrics get = 5;
  OpAggregateMetrics put = 6;
  OpAggregateMetrics meta = 7;
  
  // Overall percentiles (from combined histogram)
  uint64 p50_us = 8;
  uint64 p95_us = 9;
  uint64 p99_us = 10;
  
  // v0.6.4: Agent results collection (inline for small results)
  string console_log = 11;       // Agent console output
  string metadata_json = 12;     // Agent metadata JSON
  string tsv_content = 13;       // TSV results data
  string results_path = 14;      // Local path where agent saved results
  string op_log_path = 15;       // Optional: path to operation log (not transferred)
  
  // v0.6.4: HDR histogram data for accurate aggregation
  bytes histogram_get = 16;      // Serialized GET histograms (all size buckets)
  bytes histogram_put = 17;      // Serialized PUT histograms (all size buckets)
  bytes histogram_meta = 18;     // Serialized META histograms (all size buckets)
}

// v0.7.9: Prepare phase summary (similar to WorkloadSummary but for object creation)
message PrepareSummary {
  string agent_id = 1;
  double wall_seconds = 2;
  uint64 objects_created = 3;
  uint64 objects_existed = 4;
  
  // PUT operation aggregates (object creation)
  OpAggregateMetrics put = 5;
  
  // MKDIR operation aggregates (directory creation)
  OpAggregateMetrics mkdir = 6;
  uint64 mkdir_count = 7;
  
  // v0.7.9: HDR histogram data for accurate aggregation
  bytes histogram_put = 8;       // Serialized PUT histograms (all size buckets)
  
  // v0.7.9: TSV content for agent-level prepare results
  string tsv_content = 9;        // Prepare results TSV data
  string results_path = 10;      // Local path where agent saved prepare_results.tsv
}

// v0.7.5: Live performance statistics for distributed execution
// Sent every 1 second during workload execution for real-time visibility
message LiveStats {
  string agent_id = 1;
  double timestamp_s = 2;        // Seconds since workload start
  
  // GET operations (read from storage)
  uint64 get_ops = 3;
  uint64 get_bytes = 4;
  double get_mean_us = 5;
  double get_p50_us = 6;
  double get_p95_us = 7;
  
  // PUT operations (write to storage)
  uint64 put_ops = 8;
  uint64 put_bytes = 9;
  double put_mean_us = 10;
  double put_p50_us = 11;
  double put_p95_us = 12;
  
  // META operations (LIST/HEAD/DELETE/etc.)
  uint64 meta_ops = 13;
  double meta_mean_us = 14;
  
  double elapsed_s = 15;
  bool completed = 16;           // True on final message
  
  // v0.7.5: Optional final summary (only present when completed=true)
  // Allows controller to collect complete results for persistence
  WorkloadSummary final_summary = 17;
  
  // v0.7.6: Startup handshake for robust error handling
  enum Status {
    UNKNOWN = 0;
    READY = 1;       // Agent validated config and is ready to start
    RUNNING = 2;     // Workload is executing (normal stats messages)
    ERROR = 3;       // Agent encountered startup error (see error_message)
    COMPLETED = 4;   // Workload finished successfully
    ABORTED = 5;     // Agent gracefully aborted by controller
    ACKNOWLEDGE = 6; // Response to PING command
  }
  Status status = 18;
  string error_message = 19;     // Details if status == ERROR or ABORTED
  
  // v0.7.9: Prepare phase progress tracking (DEPRECATED: use current_stage instead)
  bool in_prepare_phase = 20;    // True if currently in prepare phase
  uint64 prepare_objects_created = 21;  // Objects created so far
  uint64 prepare_objects_total = 22;    // Total objects to create
  
  // v0.7.9: Prepare phase summary (only present when prepare completes)
  PrepareSummary prepare_summary = 23;
  
  // v0.7.11: CPU utilization metrics (sampled every 5 seconds)
  double cpu_user_percent = 24;    // User mode CPU utilization (0-100%)
  double cpu_system_percent = 25;  // System/kernel mode CPU utilization (0-100%)
  double cpu_iowait_percent = 26;  // IO-wait CPU time (0-100%)
  double cpu_total_percent = 27;   // Total CPU utilization (user+system+iowait)
  
  // v0.8.4: Clock synchronization for coordinated start
  // When status=READY, agent includes its current timestamp
  // Controller calculates offset and adjusts start_timestamp_ns accordingly
  int64 agent_timestamp_ns = 28;   // Agent's system time (nanoseconds since UNIX epoch)
  
  // v0.8.4: Sequence number for message tracking and acknowledgment
  // Allows controller to confirm receipt of specific messages (e.g., READY status)
  int64 sequence = 29;
  
  // v0.8.9: Flexible stage system for multi-phase execution
  // Replaces the limited in_prepare_phase bool with a proper stage enum
  // Allows controller to display appropriate progress for each stage
  enum WorkloadStage {
    STAGE_UNKNOWN = 0;    // Unknown/unset (backward compat)
    STAGE_PREPARE = 1;    // Creating objects before workload
    STAGE_WORKLOAD = 2;   // Main benchmark execution (GET/PUT/etc.)
    STAGE_CLEANUP = 3;    // Deleting objects after workload
    STAGE_LISTING = 4;    // v0.8.14: Scanning existing objects before prepare
    STAGE_CUSTOM = 10;    // User-defined custom stage (use stage_name)
  }
  WorkloadStage current_stage = 30;      // Current execution stage
  string stage_name = 31;                // Human-readable stage name (esp. for CUSTOM)
  uint64 stage_progress_current = 32;    // Progress within stage (objects created/deleted, etc.)
  uint64 stage_progress_total = 33;      // Total items for this stage (0 = time-based like workload)
  double stage_elapsed_s = 34;           // Seconds since this stage started
  
  // v0.8.14: Agent concurrency for total thread count display
  uint32 concurrency = 35;               // Number of concurrent workers on this agent
}

service Agent {
  rpc Ping(Empty) returns (PingReply);
  rpc RunGet(RunGetRequest) returns (OpSummary);
  rpc RunPut(RunPutRequest) returns (OpSummary);
  rpc RunWorkload(RunWorkloadRequest) returns (WorkloadSummary);  // v0.6.0
  
  // v0.7.5: Server streaming for live progress updates during distributed execution
  rpc RunWorkloadWithLiveStats(RunWorkloadRequest) returns (stream LiveStats);
  
  // v0.7.11: Abort ongoing workload (controller failure, user interrupt, etc.)
  rpc AbortWorkload(Empty) returns (Empty);
  
  // v0.8.4: Bidirectional streaming for robust control and stats
  // Controller sends control messages (start, abort, ping)
  // Agent sends stats updates (ready, progress, completed)
  // Allows real-time coordination without blocking either side
  rpc ExecuteWorkload(stream ControlMessage) returns (stream LiveStats);
}

// v0.8.4: Control messages from controller to agent
message ControlMessage {
  enum Command {
    PING = 0;           // Keepalive / connection check
    START = 1;          // Begin workload execution
    ABORT = 2;          // Cancel workload immediately
    ACKNOWLEDGE = 3;    // Acknowledge receipt of agent message
  }
  Command command = 1;
  
  // For START command: workload configuration
  string config_yaml = 2;
  string agent_id = 3;
  string path_prefix = 4;
  int64 start_timestamp_ns = 5;
  bool shared_storage = 6;
  
  // For ACKNOWLEDGE: which message we're acknowledging
  int64 ack_sequence = 7;
  
  // v0.8.7: For distributed cleanup with shared storage
  // agent_index: 0-based agent index (0, 1, 2, ...)
  // num_agents: total number of agents in the distributed execution
  // Used for deterministic object distribution: file_idx % num_agents == agent_index
  uint32 agent_index = 8;
  uint32 num_agents = 9;
}

