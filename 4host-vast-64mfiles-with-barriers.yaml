###################################################################################
# Large-Scale Distributed Test with Barrier Synchronization
# 
# Scale: 331,776 directories, 64,032,768 files (~500 TB)
# Agents: 4 hosts with 16 total endpoints
# Configuration: v0.8.51 with extended timeouts for large-scale operations
#
# Key Features:
# - Barrier sync enabled with phase-specific timeouts
# - Extended agent_ready_timeout (600s for >1M file validation)
# - Optimized gRPC keepalive for heavy I/O workloads
# - Best-effort cleanup (don't block on failures)
# - Multi-endpoint load balancing per agent
###################################################################################


# Number of total outstanding jobs
concurrency: 64
# POSIX fadvise pagecache hints: may be: sequential, dontneed, auto, normal, random
page_cache_mode: dontneed  # Specify NOT to use page cache 

perf_log:
  enabled: true
  interval: 1s

# Prepare phase: Create 500 TB of test data
prepare:
  prepare_strategy: parallel
  skip_verification: true   # Skip LIST - no point checking if we're overwriting anyway
  force_overwrite: true     # Create all files, overwriting if they exist


  # Create nested directory tree:
  # width=24, depth=4 → 24^4 = 331,776 leaf directories
  # 193 files per leaf directory × 331,776 dirs = 64,032,768 files
  # 64M files × 8 MB average = 512,000 MB = ~500 TB
  directory_structure:
    width: 24                    # 24 subdirectories per level
    depth: 4                     # 4 levels deep
    files_per_dir: 193           # 193 files per leaf directory
    distribution: "bottom"       # Files only in leaf directories
    dir_mask: "d%d_w%d.dir"

  # Total files calculation: 331,776 leaf dirs × 193 files/dir = 64,032,768 files
  ensure_objects:
    - # NO base_uri - each agent uses first multi_endpoint for listing
      count: 64032768           # 64M files × 8 MB avg = ~500 TB
      fill: random
      size_distribution:
        type: lognormal
        mean: 8MiB           # 8 MB mean
        std_dev: 1MiB        # 1 MB standard deviation
        min: 1MiB            # 1 MB min
        max: 16MiB           # 16 MB max
      use_multi_endpoint: true

  cleanup: false  # Keep data for later use

# Dummy workload (won't run with duration: 0s)
workload:
  - op: get
    path: "d*_w*.dir/**/*"
    weight: 100
    use_multi_endpoint: true
duration: 30s

# Distributed configuration with barrier sync and optimized timeouts
distributed:
  shared_filesystem: false      # Each agent has isolated storage
  tree_creation_mode: isolated  # Each agent creates its own tree
  path_selection: random

  #############################################################################
  # gRPC Communication Timeouts (v0.8.51 optimized for large-scale)
  #############################################################################
  grpc_keepalive_interval: 60    # PING every 60s (reduced frequency for long operations)
  grpc_keepalive_timeout: 30     # Wait 30s for PONG (increased from default 10s for heavy I/O)
  agent_ready_timeout: 600       # 10 minutes for large glob validation (>1M files)
                                 # Agents validate config including glob expansion before READY

  #############################################################################
  # Barrier Synchronization (v0.8.50+)
  #############################################################################
  barrier_sync:
    enabled: true
    
    # VALIDATION phase: Quick config checks
    validation:
      type: all_or_nothing
      heartbeat_interval: 30           # Report every 30s
      missed_threshold: 3              # Query after 90s of silence
      query_timeout: 10                # 10s per query
      query_retries: 2                 # 2 retries = 30s total query time
      agent_barrier_timeout: 300       # 5 minutes to reach barrier
    
    # PREPARE phase: Extended timeouts for 331k tree + 64M file creation
    # Tree generation: ~90 seconds
    # File creation: 4-44 hours depending on storage speed (16M files per agent)
    # Agent variance: Fastest agent may finish hours before slowest
    # Note: skip_verification=true eliminates LIST phase (would be ~107 min @ 10k/sec)
    prepare:
      type: all_or_nothing
      heartbeat_interval: 120          # Report every 2 minutes (less frequent for long ops)
      missed_threshold: 10             # Query after 20 minutes of silence (120s × 10)
      query_timeout: 60                # 60s per query (longer for slow I/O)
      query_retries: 5                 # 5 retries = 5 minutes total query time
      #agent_barrier_timeout: 172800    # 48 hours (effectively infinite for realistic workloads)
      agent_barrier_timeout: 2d    # 48 hours (effectively infinite for realistic workloads)
                                       # Prepare takes as long as it takes - no artificial deadline
    
    # EXECUTE phase: Standard timeouts (not used in this prepare-only test)
    execute:
      type: all_or_nothing
      heartbeat_interval: 30
      missed_threshold: 3
      query_timeout: 10
      query_retries: 2
      agent_barrier_timeout: 300       # 5 minutes

  #############################################################################
  # Explicit Stage Ordering (v0.8.24+)
  # Note: Cleanup stage intentionally EXCLUDED to keep data (respects prepare.cleanup: false)
  #############################################################################
  stages:
    - name: "preflight"
      order: 1
      completion: validation_passed
      type: validation
      timeout_secs: 300
    
    - name: "prepare"  
      order: 2
      completion: tasks_done
      type: prepare
    
    - name: "execute"
      order: 3
      completion: duration
      type: execute
      duration: 30s

  #############################################################################
  # Agent Configuration with Multi-Endpoint Load Balancing
  #############################################################################
  agents:
    # Agent 1: 172.21.4.10 → Mount points 1-4
    - address: "172.21.4.10:7761"
      id: "agent-1"
      concurrency_override: 16
      multi_endpoint:
        endpoints:
          - "file:///mnt/vast1/benchmark/"
          - "file:///mnt/vast2/benchmark/"
          - "file:///mnt/vast3/benchmark/"
          - "file:///mnt/vast4/benchmark/"
        strategy: round_robin

    # Agent 2: 172.21.4.11 → Mount points 5-8
    - address: "172.21.4.11:7761"
      id: "agent-2"
      concurrency_override: 16
      multi_endpoint:
        endpoints:
          - "file:///mnt/vast5/benchmark/"
          - "file:///mnt/vast6/benchmark/"
          - "file:///mnt/vast7/benchmark/"
          - "file:///mnt/vast8/benchmark/"
        strategy: round_robin

    # Agent 3: 172.21.4.12 → Mount points 9-12
    - address: "172.21.4.12:7761"
      id: "agent-3"
      concurrency_override: 16
      multi_endpoint:
        endpoints:
          - "file:///mnt/vast9/benchmark/"
          - "file:///mnt/vast10/benchmark/"
          - "file:///mnt/vast11/benchmark/"
          - "file:///mnt/vast12/benchmark/"
        strategy: round_robin

    # Agent 4: 172.21.4.13 → Mount points 13-16
    - address: "172.21.4.13:7761"
      id: "agent-4"
      concurrency_override: 16
      multi_endpoint:
        endpoints:
          - "file:///mnt/vast13/benchmark/"
          - "file:///mnt/vast14/benchmark/"
          - "file:///mnt/vast15/benchmark/"
          - "file:///mnt/vast16/benchmark/"
        strategy: round_robin

###################################################################################
# Usage Instructions
###################################################################################
#
# 1. Start agents on all 4 hosts:
#    host1$ sai3bench-agent --port 7761
#    host2$ sai3bench-agent --port 7761
#    host3$ sai3bench-agent --port 7761
#    host4$ sai3bench-agent --port 7761
#
# 2. Validate configuration (dry run):
#    controller$ sai3-bench run --config 4host-large-scale-with-barriers.yaml --dry-run
#
# 3. Execute prepare phase (creates 500 TB across 16 endpoints):
#    controller$ sai3-bench run --config 4host-large-scale-with-barriers.yaml
#
# Expected Timeline:
# - Config validation: ~10 minutes (glob expansion with agent_ready_timeout=600s)
# - Tree generation: ~90 seconds (331k dirs across 4 agents)
# - File creation: 4-44 hours (16M files per agent, depends on storage speed)
# - Prepare barrier: 48-hour timeout (effectively infinite - takes as long as it takes)
# - Barrier sync overhead: ~1-2 minutes between phases
# 
# Note: skip_verification=true eliminates ~107 min LIST phase (unnecessary with force_overwrite)
#
# Monitoring:
# - Watch for "Barrier sync: waiting for all agents" messages
# - Agent heartbeats logged every 120s (prepare) or 30s (validation/execute)
# - gRPC keepalive PINGs every 60s
# - Performance log written every 1s (perf_log.tsv)
#
# Timeout Escalation:
# - Prepare timeout: 48 hours (172800s) - should never hit this for realistic workloads
# - If agents disconnect during long I/O → increase grpc_keepalive_timeout
# - If glob validation fails → increase agent_ready_timeout beyond 600s
#
###################################################################################
