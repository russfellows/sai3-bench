# unet3d_gcs_test.yaml - 4 agents matching rdf-bench parameters
# GCS version of unet3d workload with nested directory structure
# 
# Matches rdf-bench config: width=28, depth=2, files=64 per host
# Size distribution matches: sizes=(1m,10,2m,20,4m,30,8m,25,16m,10,32m,5)
#
# rdf-bench equivalent: 4 hosts × 50,176 files = 200,704 files total
# Directory Structure:
#   width=28, depth=2 → 28 × 28 = 784 leaf directories
#   784 dirs × 64 files = 50,176 files per host
#   4 hosts × 50,176 = 200,704 total files
#
# Average file size: ~6.9 MB (weighted average from rdf-bench distribution)
# Total dataset: ~1.35 TB (4 hosts × 338 GB)

target: "gs://signal65-ai-ac/unet3d/"
duration: "5m"       # 300s run (matches rdf-bench rd_run elapsed=300)
concurrency: 32      # Matches rdf-bench threads=32

prepare:
  prepare_strategy: parallel
  skip_verification: true
  
  # Create nested directory tree matching rdf-bench FSD:
  # width=28, depth=2, files=64 (per host in rdf-bench)
  # rdf-bench: each of 4 hosts creates 784×64=50,176 files
  # sai3-bench: coordinator creates 4×50,176=200,704 files (no bug!)
  directory_structure:
    width: 28                # 28 subdirectories per level (matches rdf-bench)
    depth: 2                 # 2 levels deep (matches rdf-bench)
    files_per_dir: 256       # 64 files/host × 4 hosts = 256 files per directory
    distribution: "bottom"   # Files only in leaf directories
    dir_mask: "scan.d%d_w%d.dir"
  
  # Total files calculation: 784 leaf dirs × 256 files/dir = 200,704 files
  # This matches rdf-bench: 4 hosts × 50,176 files/host = 200,704 files
  ensure_objects:
    - base_uri: "gs://signal65-ai-ac/unet3d/"
      count: 200704  # 784 dirs × 256 files = 4 hosts × 50,176 files/host
      fill: random
      size_spec:
        type: lognormal
        mean: 7235174      # ~6.90 MB (matches rdf-bench weighted avg)
        std_dev: 5788139   # ~5.52 MB (provides spread similar to discrete dist)
        min: 1048576       # 1 MB minimum (matches rdf-bench)
        max: 33554432      # 32 MB maximum (matches rdf-bench)
      dedup_factor: 1
      compress_factor: 1
  
  cleanup: false  # Keep data between runs

workload:
  # Sequential reads matching rdf-bench:
  # operation=read, fileio=sequential, xfersize=1m
  # Each worker will select files uniformly at random
  
  - op: get
    path: "scan.d*_w*.dir/**/*"  # Match actual directory structure
    weight: 100

# Distributed Configuration (1 controller + 4 workers)
distributed:
  shared_filesystem: true  # GCS is shared across all agents
  tree_creation_mode: coordinator  # Controller creates directory tree once
  path_selection: random  # Random file selection for workload
  agents:
    - address: "10.138.0.42:7761"
      id: "agent-1"
    - address: "10.138.0.43:7761"
      id: "agent-2"
    - address: "10.138.0.44:7761"
      id: "agent-3"
    - address: "10.138.0.45:7761"
      id: "agent-4"
