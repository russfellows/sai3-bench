###################################################################################
# Local 2-Agent Test with Multi-Endpoint (4 paths on /mnt/nvme_data)
# 
# Scale: Small test (16 dirs, 160 files, ~16 MB)
# Agents: 2 local agents (127.0.0.1) with 2 endpoints each
# Purpose: Test YAML-driven stages + barrier sync with explicit stages
###################################################################################

# Base target (overridden by multi_endpoint)
target: "file:///mnt/nvme_data/sai3-test/"

concurrency: 32
page_cache_mode: auto

perf_log:
  enabled: true
  interval: 1s

# Prepare phase: Create small test dataset
prepare:
  prepare_strategy: parallel
  skip_verification: true
  force_overwrite: true

  # Small directory tree for testing
  # width=2, depth=2 → 2^2 = 4 leaf directories per agent (8 total)
  # 16 files per leaf directory 
  directory_structure:
    width: 2
    depth: 2
    files_per_dir: 40
    distribution: "bottom"
    dir_mask: "d%d_w%d.dir"

  # Total: 160 files × ~100 KB = ~16 MB
  ensure_objects:
    - count: 160
      fill: random
      size_distribution:
        type: lognormal
        mean: 100KiB
        std_dev: 20KiB
        min: 50KiB
        max: 200KiB
      use_multi_endpoint: true

  cleanup: false

# Short workload for testing
workload:
  - op: get
    path: "d*_w*.dir/**/*"
    weight: 100
    use_multi_endpoint: true
duration: 5s

# Distributed configuration with barrier sync
distributed:
  shared_filesystem: false
  tree_creation_mode: isolated
  path_selection: random

  # gRPC Communication Timeouts
  grpc_keepalive_interval: 60
  grpc_keepalive_timeout: 30
  agent_ready_timeout: 120

  # Barrier Synchronization - 
  barrier_sync:
    enabled: true
    
    validation:
      type: all_or_nothing
      heartbeat_interval: 10
      missed_threshold: 3
      query_timeout: 5
      query_retries: 2
      agent_barrier_timeout: 60
    
    prepare:
      type: all_or_nothing
      heartbeat_interval: 30
      missed_threshold: 3
      query_timeout: 10
      query_retries: 2
      agent_barrier_timeout: 300
    
    execute:
      type: all_or_nothing
      heartbeat_interval: 10
      missed_threshold: 3
      query_timeout: 5
      query_retries: 2
      agent_barrier_timeout: 60

  # Should now work without "duplicate field" error!
  stages:
    - name: "preflight"
      order: 1
      completion: validation_passed
      type: validation
      timeout_secs: 60       # ← THIS was causing duplicate field error!
    
    - name: "prepare"  
      order: 2
      completion: tasks_done
      type: prepare
    
    - name: "execute"
      order: 3
      completion: duration
      type: execute
      duration: 5s

  #############################################################################
  # Agent Configuration with Multi-Endpoint Load Balancing
  # 2 LOCAL agents, each with 2 endpoints on /mnt/nvme_data
  #############################################################################
  agents:
    # Agent 1: localhost:7761 → /mnt/nvme_data paths 1 and 2
    - address: "127.0.0.1:7761"
      id: "agent-1"
      concurrency_override: 16
      multi_endpoint:
        endpoints:
          - "file:///mnt/nvme_data/sai3-path1/"
          - "file:///mnt/nvme_data/sai3-path2/"
        strategy: round_robin

    # Agent 2: localhost:7762 → /mnt/nvme_data paths 3 and 4
    - address: "127.0.0.1:7762"
      id: "agent-2"
      concurrency_override: 16
      multi_endpoint:
        endpoints:
          - "file:///mnt/nvme_data/sai3-path3/"
          - "file:///mnt/nvme_data/sai3-path4/"
        strategy: round_robin


